<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>ü§ñ Life Support Chat Assistant</title>
    
        <!-- Fonts -->
        <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    
        <style>
            body {
                margin: 0;
                padding: 40px;
                position: relative;
                z-index: 0;
                overflow-x: hidden;
                font-family: 'Inter', sans-serif; /* Default to Inter for everything except titles */
            }
    
            body::before {
                content: "";
                position: fixed;
                top: 0;
                left: 0;
                height: 100%;
                width: 100%;
                background: url('/static/images/cupola-audio-terminal-unit.jpg') no-repeat center center;
                background-size: cover;
                z-index: -3;
                pointer-events: none;
                will-change: transform, opacity;
            }
    
            h1 {
                text-align: center;
                color: #ffffff;
                text-shadow: 0 0 8px #000;
                font-family: 'Orbitron', sans-serif;
            }
    
        .chat-box {
            background-color: #0a0a0a; /* Solid black */
            border-radius: 16px;
            box-shadow: 0 0 12px rgba(255,255,255,0.1);
            padding: 16px;
            display: flex;
            flex-direction: column;
            height: 85vh;
            max-width: 1000px;
            margin: 0 auto;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.1), 0 0 12px rgba(255,255,255,0.15);
        }

        .messages {
            background-color: #1a1a1a; /* Dark solid for scroll area */
            border-radius: 10px;
            padding: 16px;
            overflow-y: auto;
            flex: 1;
        }


        .message-input {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-top: auto;
        }

        .message-input input {
            flex: 1;
            padding: 10px;
            font-size: 16px;
            border-radius: 6px;
            border: 1px solid #444;
            background: #111;
            color: #fff;
        }

        .message-input button {
            padding: 10px 20px;
            background-image: url('/static/images/beautiful-space-background-vector.jpg');
            background-size: cover;
            background-position: center;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
        }

        .message.user, .message.bot {
            display: flex;
            align-items: flex-start;
            margin-bottom: 16px;
            max-width: 95%;
            word-wrap: break-word;
            animation: fadeIn 0.4s ease-in;
        }

        .message.user {
            justify-content: flex-end;
            text-align: right;
        }

        .message.bot {
            justify-content: flex-start;
            text-align: left;
        }

        .bubble {
            padding: 12px 16px;
            border-radius: 16px;
            font-family: 'Inter', sans-serif;
            font-size: 16px;
            line-height: 1.4;
            max-width: 80%;
            box-shadow: 0 0 12px rgba(0,0,0,0.2);
        }

        .user .bubble {
            background: linear-gradient(to bottom right, #262262, #4f4498);
            color: white;
            border-bottom-right-radius: 0;
        }

        .bot .bubble {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(8px);
            color: #eee;
            border-bottom-left-radius: 0;
            border: 1px solid rgba(255,255,255,0.1);
            max-width: 85%;  /* ‚¨ÖÔ∏è Match user bubble width */
        }



        .avatar {
            width: 36px;
            height: 36px;
            margin: 4px 10px;
            font-size: 24px;
        }

        input {
            width: 75%;
            padding: 10px;
            font-size: 16px;
            border-radius: 6px;
            border: 1px solid #444;
            background: #111;
            color: #fff;
            margin-top: 10px;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            margin-left: 10px;
            background-image: url('/static/images/beautiful-space-background-vector.jpg');
            background-size: cover;
            background-position: center;
            color: white;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(255,255,255,0.3);
        }

        button:hover {
            transform: scale(1.05);
        }

        .nav-select {
            position: fixed;
            top: 20px;
            right: 40px;
            z-index: 20;
        }

        .nav-select select {
            padding: 8px;
            border-radius: 6px;
            background-color: #111;
            color: #fff;
            font-family: 'Orbitron', sans-serif;
            box-shadow: 0 0 6px rgba(255,255,255,0.2);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(4px); }
            to { opacity: 1; transform: translateY(0); }
        }
    
            #floating-astro {
                position: fixed;
                top: 30%;
                left: 2%;
                width: 180px;
                opacity: 1.0;
                transform: translate(-50%, -50%);
                z-index: -2;
                animation: drift-astro 60s linear infinite alternate;
                pointer-events: none;
                filter: drop-shadow(0 0 6px rgba(255,255,255,0.5));
            }
    
            #cupola-frame {
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                object-fit: cover;
                z-index: -1;
                pointer-events: none;
            }
    
            @keyframes drift-astro {
                0% { transform: translate(0, 0) rotate(-10deg) scale(1.0); }
                30% { transform: translate(-120px, 40px) rotate(8deg) scale(1.00); }
                60% { transform: translate(100px, -80px) rotate(12deg) scale(1.00); }
                90% { transform: translate(70px, 70px) rotate(-18deg) scale(1.00); }
                100% { transform: translate(-50px, -30px) rotate(-2deg) scale(1.00); }
            }
    
            .nav-select {
                position: fixed;
                top: 20px;
                right: 40px;
                z-index: 20;
            }
    
            .nav-select select {
                padding: 8px;
                border-radius: 6px;
                background-color: #111;
                color: #fff;
                font-family: 'Orbitron', sans-serif;
                box-shadow: 0 0 6px rgba(255,255,255,0.2);
            }
        </style>
</head>
<body>
    <img id="cupola-frame" src="{{ url_for('static', filename='images/cupola-audio-terminal-unit.png') }}" alt="Cupola Frame">
    <img id="floating-astro" src="{{ url_for('static', filename='images/Bruce_McCandless_II_during_EVA_in_1984.png') }}" alt="Astronaut Floating">

    <div class="nav-select">
        <select onchange="if (this.value) window.location.href=this.value;">
            <option value="">üåê Navigate to...</option>
            <option value="/">üè† Home</option>
            <option value="/meal_log">üìÖ Meal Log</option>
            <option value="/setup_foods">ü•ó Food & Beverage Setup</option>
            <option value="/upload_food_csv">üì§ Upload Food CSV</option>
            <option value="/beverage_upload">üì§ Upload Beverage CSV</option>
            <option value="/clear_all_databases">üíæ Reset All Databases</option>
            <option value="/chat">ü§ñ Chat with AI Assistant</option>
            <option value="/medical_assistant">üß¨ Medical Assistant</option>
        </select>
    </div>

    <h1>üî¥ Life Support Chat Assistant (HAL 9000)</h1>

    <div class="chat-box">
        <div class="messages" id="messages"></div>
    
        <div class="message-input">
            <input id="userInput" placeholder="Ask HAL..." onkeydown="handleKey(event)" />
            <button onclick="sendMessage()">Send</button>
        </div>
    
        <div style="margin-top: 10px; display: flex; justify-content: center; gap: 20px;">
            <label style="color: white; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="voiceToggle" />
                üîä Narrate AI Replies
            </label>
            <label style="color: white; font-size: 14px;">
                <input type="checkbox" id="multiTurnToggle" />
                üîÅ Multi-Turn Mode
            </label>   
            <button onclick="startVoiceInput()">üéôÔ∏è Speak</button>
            <button onclick="clearChat()" style="background-color: crimson;">üßº Clear Chat</button>
        </div>
    </div>

    <script>
        function renderMultiTurnToolOutput(rawText) {
            const matchToolCall = rawText.match(/tool:(\w+)\(\s*([\s\S]*?)\s*\)/);
            const matchTable = rawText.match(/__table__\s*([\s\S]+?)\s*__end__/);
            let result = "";

            // üõ†Ô∏è Tool Call Table
            if (matchToolCall) {
                const toolName = matchToolCall[1];
                let argsRaw = matchToolCall[2].trim();

                try {
                    // ‚úÖ Clean up and sanitize for JSON parsing
                    let jsonStr = argsRaw
                        .replace(/(['"])?([a-zA-Z0-9_]+)(['"])?\s*:/g, '"$2":') // ensure keys quoted
                        .replace(/'/g, '"') // normalize quotes
                        .replace(/\bTrue\b/g, 'true')
                        .replace(/\bFalse\b/g, 'false')
                        .replace(/\bNone\b/g, 'null')
                        .replace(/,\s*([}\]])/g, '$1'); // remove trailing commas

                    if (!jsonStr.trim().startsWith("{") || !jsonStr.trim().endsWith("}")) {
                        throw new Error("Tool arguments must be a valid object literal.");
                    }

                    const parsedArgs = JSON.parse(jsonStr);

                    const argRows = Object.entries(parsedArgs).map(
                        ([key, val]) => `<tr><td style="padding: 6px 12px; border: 1px solid #444;"><code>${key}</code></td>
                                            <td style="padding: 6px 12px; border: 1px solid #444;">${String(val)}</td></tr>`
                    ).join("");

                    result += `
                        <div style="margin-top: 14px;">
                            <strong>‚öôÔ∏è Tool Call: <code>${toolName}</code></strong>
                            <table style="width: 100%; margin-top: 8px; border-collapse: collapse; background: rgba(255,255,255,0.04); font-size: 14px;">
                                <thead>
                                    <tr style="border-bottom: 2px solid #666;">
                                        <th style="padding: 8px 12px; text-align: left;">Argument</th>
                                        <th style="padding: 8px 12px; text-align: left;">Value</th>
                                    </tr>
                                </thead>
                                <tbody>${argRows}</tbody>
                            </table>
                        </div>`;
                } catch (e) {
                    result += `<p style="color: red;">‚ö†Ô∏è Failed to parse tool call arguments: ${e.message}</p>`;
                }
            }

            // üìä Final Output Table
            if (matchTable) {
                try {
                    const cleanTable = matchTable[1]
                        .replace(/\\n/g, '')
                        .replace(/\\"/g, '"')
                        .replace(/\\'/g, "'");

                    const parsedTable = JSON.parse(cleanTable);
                    result += "<div style='margin-top: 20px;'>" + renderTableFromJSON(parsedTable) + "</div>";
                } catch (e) {
                    result += `<p style="color: red;">‚ö†Ô∏è Failed to parse final table output: ${e.message}</p>`;
                }
            }

            return result || rawText;
        }




        function clearChat() {
            localStorage.removeItem("hal_chat_history");
            localStorage.removeItem("hal_last_input");
            document.getElementById("messages").innerHTML = "";
            document.getElementById("userInput").value = "";

            fetch("/clear_memory", { method: "POST" })
                .then(res => console.log("‚úÖ Memory reset"))
                .catch(err => console.error("‚ùå Memory reset failed:", err));
        }

        window.addEventListener("load", () => {
            const saved = localStorage.getItem("hal_chat_history");
            if (saved) document.getElementById("messages").innerHTML = saved;

            const lastInput = localStorage.getItem("hal_last_input");
            if (lastInput) document.getElementById("userInput").value = lastInput;

            document.getElementById("userInput").addEventListener("input", () => {
                localStorage.setItem("hal_last_input", document.getElementById("userInput").value);
            });
        });

        function handleKey(event) {
            if (event.key === "Enter") {
                event.preventDefault();
                sendMessage();
            }
        }

        function speakText(text) {
            if (!document.getElementById("voiceToggle").checked) return;

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = "en-US";
            utterance.pitch = 0.8;
            utterance.rate = 0.85;
            utterance.volume = 0.9;

            const voices = window.speechSynthesis.getVoices();
            const halVoice = voices.find(v =>
                v.name.includes("Daniel") || v.name.includes("Matthew") ||
                v.name.includes("Google US English") || v.name.includes("English")
            );
            if (halVoice) utterance.voice = halVoice;

            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(utterance);
        }

        async function sendMessage() {
            const input = document.getElementById("userInput");
            const text = input.value.trim();
            if (!text) return;

            const msgBox = document.getElementById("messages");
            msgBox.innerHTML += `
                <div class="message user">
                    <div class="avatar">üë©‚ÄçüöÄ</div>
                    <div class="bubble">${text}</div>
                </div>`;
            input.value = "";

            const previewId = `preview-${Date.now()}`;
            msgBox.innerHTML += `
                <div class="message bot" id="${previewId}">
                    <div class="avatar">üî¥</div>
                    <div class="bubble"><em>Executing...</em></div>
                </div>`;

            const isMultiTurn = document.getElementById("multiTurnToggle")?.checked || false;

            try {
                const response = await fetch("/chat_api", {
                    method: "POST",
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: text,
                        multi_turn: isMultiTurn   // ‚úÖ Send toggle state
                    })
                });


                const data = await response.json();
                let botReply = data.reply || "‚ö†Ô∏è No reply";
                if (typeof botReply !== "string") {
                    botReply = JSON.stringify(botReply, null, 2);  // ‚úÖ Ensures it's a string
                }
                if (botReply.includes("‚úÖ Multi-Turn Execution Complete:") && botReply.includes("__table__")) {
                    const formatted = renderMultiTurnToolOutput(botReply);
                    botReply = formatted;
                }


                const container = document.getElementById(previewId);

                let content = botReply;
                let tableHTML = "";

                // Extract and render __table__ block
                const tableMatch = botReply.match(/__table__([\s\S]*?)__end__/);
                if (tableMatch) {
                    try {
                        const parsed = JSON.parse(tableMatch[1].trim());
                        tableHTML = renderTableFromJSON(parsed);
                        content = botReply.replace(/__table__[\s\S]*?__end__/, tableHTML);
                    } catch (e) {
                        console.error("‚ö†Ô∏è Failed to parse tool table JSON:", e);
                    }
                }

                // üìã Detect and format Multi-Turn JSON results
                const multiTurnMatch = botReply.match(/‚úÖ Multi-Turn Execution Complete:\s*<br><br>({[\s\S]*})<br><br>üéØ Final Output:/);
                if (multiTurnMatch) {
                    try {
                        const parsed = JSON.parse(multiTurnMatch[1].replaceAll("<br>", "\n"));  // fix HTML newlines
                        const stepRows = Object.entries(parsed).map(([step, output]) => `
                            <tr>
                                <td style="padding: 6px 12px; border-bottom: 1px solid #444;"><strong>Step ${step}</strong></td>
                                <td style="padding: 6px 12px; border-bottom: 1px solid #444;">${output.replace(/\n/g, "<br>")}</td>
                            </tr>`).join("");

                        const multiTurnTable = `
                            <div style="overflow-x: auto; margin-top: 12px;">
                                <table style="width: 100%; background: rgba(255,255,255,0.04); border-collapse: collapse; font-size: 14px;">
                                    <thead>
                                        <tr>
                                            <th style="padding: 8px 12px; border-bottom: 2px solid #666; text-align: left;">üß© Step</th>
                                            <th style="padding: 8px 12px; border-bottom: 2px solid #666; text-align: left;">üîç Result</th>
                                        </tr>
                                    </thead>
                                    <tbody>${stepRows}</tbody>
                                </table>
                            </div>`;

                        content = content.replace(multiTurnMatch[0], multiTurnTable);
                    } catch (e) {
                        console.error("‚ö†Ô∏è Failed to render multi-turn table:", e);
                    }
                }

                // Optional cleanup
                content = content
                    .replace(/__tool__[\s\S]*?__endtool__/, "")
                    .replace(/\n/g, "<br>");

                container.innerHTML = `
                    <div class="avatar">üî¥</div>
                    <div class="bubble">${content}</div>`;

                speakText(botReply);
            } catch (err) {
                const container = document.getElementById(previewId);
                container.innerHTML = `
                    <div class="avatar">üî¥</div>
                    <div class="bubble">üí• Error: ${err.message}</div>`;
            }

            msgBox.scrollTop = msgBox.scrollHeight;
            localStorage.setItem("hal_chat_history", msgBox.innerHTML);
            localStorage.setItem("hal_last_input", "");
        }


        function startVoiceInput() {
            const input = document.getElementById("userInput");
            const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = "en-US";
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            recognition.start();
            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                input.value = transcript;
                sendMessage();
            };

            recognition.onerror = function(event) {
                alert("Voice input error: " + event.error);
            };
        }
        function renderTableFromJSON(obj) {
        if (!Array.isArray(obj) || obj.length === 0) return `<div>No data found.</div>`;
        const keys = Object.keys(obj[0]);
        const rows = obj.map(row => `<tr>${keys.map(k => `<td>${row[k]}</td>`).join('')}</tr>`).join('');

        return `
            <table style="border-collapse: collapse; margin-top: 10px; background-color: #1b1b1b; color: #fff; border: 1px solid #666;">
                <thead><tr>${keys.map(k => `<th style="padding: 4px 8px; border: 1px solid #666;">${k}</th>`).join('')}</tr></thead>
                <tbody>${rows}</tbody>
            </table>
        `;
    }

    </script>
    
</body>
</html>
